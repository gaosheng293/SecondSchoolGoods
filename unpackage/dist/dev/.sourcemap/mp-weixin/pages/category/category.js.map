{"version":3,"file":"category.js","sources":["pages/category/category.vue","../../../HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvY2F0ZWdvcnkvY2F0ZWdvcnkudnVl"],"sourcesContent":["<!-- pages/category/category.vue -->\r\n<template>\r\n\t<view class=\"category-page\">\r\n\t\t<!-- 顶部分类导航（纯动态） -->\r\n\t\t<scroll-view scroll-x class=\"tab-bar\" v-if=\"categories.length\">\r\n\t\t\t<view class=\"tab-item\" \r\n\t\t\t\tv-for=\"tab in categories\" \r\n\t\t\t\t:key=\"tab.id\"\r\n\t\t\t\t:class=\"{ active: currentTab === tab.id }\"\r\n\t\t\t\t@click=\"switchTab(tab.id)\">\r\n\t\t\t\t{{ tab.name }}\r\n\t\t\t</view> \r\n\t\t</scroll-view>\r\n\r\n\t\t<!-- 商品列表（瀑布流） -->\r\n\t\t<view class=\"goods-list\">\r\n\t\t\t<view class=\"column\">\r\n\t\t\t\t<view v-for=\"item in leftList\" :key=\"item.id\" class=\"goods-card\" @click=\"toDetail(item.id)\">\r\n\t\t\t\t\t<image :src=\"item.cover || defaultCover\" mode=\"aspectFill\" class=\"cover\" />\r\n\t\t\t\t\t<view class=\"info\">\r\n\t\t\t\t\t\t<text class=\"title\">{{ item.title }}</text>\r\n\t\t\t\t\t\t<text class=\"price\">¥{{ item.price }}</text>\r\n\t\t\t\t\t\t<view class=\"tags\" v-if=\"item.isNegotiable || item.isFreeShipping\">\r\n\t\t\t\t\t\t\t<text class=\"tag\" v-if=\"item.isNegotiable\">可刀</text>\r\n\t\t\t\t\t\t\t<text class=\"tag\" v-if=\"item.isFreeShipping\">包邮</text>\r\n\t\t\t\t\t\t</view>\r\n\t\t\t\t\t</view>\r\n\t\t\t\t</view>\r\n\t\t\t</view>\r\n\t\t\t<view class=\"column\">\r\n\t\t\t\t<view v-for=\"item in rightList\" :key=\"item.id\" class=\"goods-card\" @click=\"toDetail(item.id)\">\r\n\t\t\t\t\t<image :src=\"item.cover || defaultCover\" mode=\"aspectFill\" class=\"cover\" />\r\n\t\t\t\t\t<view class=\"info\">\r\n\t\t\t\t\t\t<text class=\"title\">{{ item.title }}</text>\r\n\t\t\t\t\t\t<text class=\"price\">¥{{ item.price }}</text>\r\n\t\t\t\t\t\t<view class=\"tags\" v-if=\"item.isNegotiable || item.isFreeShipping\">\r\n\t\t\t\t\t\t\t<text class=\"tag\" v-if=\"item.isNegotiable\">可刀</text>\r\n\t\t\t\t\t\t\t<text class=\"tag\" v-if=\"item.isFreeShipping\">包邮</text>\r\n\t\t\t\t\t\t</view>\r\n\t\t\t\t\t</view>\r\n\t\t\t\t</view>\r\n\t\t\t</view>\r\n\t\t</view>\r\n\r\n\t\t<!-- 各种状态提示 -->\r\n\t\t<view v-if=\"!categories.length && !loadingCategories\" class=\"empty\">\r\n\t\t\t<text>加载分类失败，请下拉刷新</text>\r\n\t\t</view>\r\n\r\n\t\t<view v-if=\"categories.length && !goodsList.length && !loading && !firstLoad\" class=\"empty\">\r\n\t\t\t<image src=\"/static/empty.png\" mode=\"widthFix\" class=\"empty-img\" />\r\n\t\t\t<text>该分类暂无商品~</text>\r\n\t\t</view>\r\n\r\n\t\t<view v-if=\"hasMore && goodsList.length > 0\" class=\"load-more\" @click=\"loadMore\">\r\n\t\t\t加载更多\r\n\t\t</view>\r\n\t\t<view v-else-if=\"!hasMore && goodsList.length > 0\" class=\"no-more\">没有更多了~</view>\r\n\t</view>\r\n</template>\r\n\r\n<script>\r\nexport default {\r\n\tdata() {\r\n\t\treturn {\r\n\t\t\tdefaultCover: 'https://img.yzcdn.cn/vant/cat.jpeg',\r\n\t\t\t\r\n\t\t\tcategories: [],      // 纯动态\r\n\t\t\tcurrentTab: null,    // 初始为 null，加载完 categories 后再设默认选中第一个\r\n\t\t\t\r\n\t\t\tpage: 1,\r\n\t\t\tsize: 20,\r\n\t\t\tgoodsList: [],\r\n\t\t\tleftList: [],\r\n\t\t\trightList: [],\r\n\t\t\t\r\n\t\t\tloading: false,\r\n\t\t\tloadingCategories: false,\r\n\t\t\thasMore: true,\r\n\t\t\tfirstLoad: true\r\n\t\t}\r\n\t},\r\n\r\n\tonLoad(options) {\r\n\t\t// 如果从首页点某个分类进来，预设 id\r\n\t\tif (options.id) {\r\n\t\t\tthis.currentTab = Number(options.id)\r\n\t\t}\r\n\t\tthis.fetchCategories()\r\n\t},\r\n\r\n\tonPullDownRefresh() {\r\n\t\tthis.page = 1\r\n\t\tthis.goodsList = []\r\n\t\tPromise.all([this.fetchCategories(), this.loadGoods()]).finally(() => {\r\n\t\t\tuni.stopPullDownRefresh()\r\n\t\t})\r\n\t},\r\n\r\n\tonReachBottom() {\r\n\t\tif (this.hasMore && !this.loading) this.loadMore()\r\n\t},\r\n\r\n\tmethods: {\r\n\t\t// 加载分类（和 index.vue 完全一致）\r\n\t\tasync fetchCategories() {\r\n\t\t\tthis.loadingCategories = true\r\n\t\t\tconst token = uni.getStorageSync('token')\r\n\t\t\tif (!token) {\r\n\t\t\t\tthis.loadingCategories = false\r\n\t\t\t\treturn\r\n\t\t\t}\r\n\r\n\t\t\ttry {\r\n\t\t\t\tconst res = await uni.request({\r\n\t\t\t\t\turl: 'http://192.168.0.105:8080/api/categories',\r\n\t\t\t\t\theader: { Authorization: 'Bearer ' + token }\r\n\t\t\t\t})\r\n\t\t\t\tconst result = res[1] || res\r\n\r\n\t\t\t\tif (result?.statusCode === 200 && Array.isArray(result.data)) {\r\n\t\t\t\t\tthis.categories = result.data\r\n\r\n\t\t\t\t\t// 关键：如果当前没有选中任何 tab，默认选中第一个\r\n\t\t\t\t\tif (!this.currentTab && this.categories.length > 0) {\r\n\t\t\t\t\t\tthis.currentTab = this.categories[0].id\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// 如果当前选中的 tab 已经不在列表里了（比如被管理员删了），自动切到第一个\r\n\t\t\t\t\tif (this.currentTab && !this.categories.find(c => c.id === this.currentTab)) {\r\n\t\t\t\t\t\tthis.currentTab = this.categories[0].id\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// 分类加载完后立即加载对应商品\r\n\t\t\t\t\tif (this.page === 1) this.loadGoods()\r\n\t\t\t\t}\r\n\t\t\t} catch (e) {\r\n\t\t\t\tconsole.log('分类加载失败', e)\r\n\t\t\t\tuni.showToast({ title: '加载分类失败', icon: 'none' })\r\n\t\t\t} finally {\r\n\t\t\t\tthis.loadingCategories = false\r\n\t\t\t}\r\n\t\t},\r\n\r\n\t\tswitchTab(tabId) {\r\n\t\t\tif (this.currentTab === tabId) return\r\n\t\t\tthis.currentTab = tabId\r\n\t\t\tthis.page = 1\r\n\t\t\tthis.goodsList = []\r\n\t\t\tthis.hasMore = true\r\n\t\t\tthis.firstLoad = true\r\n\t\t\tthis.loadGoods()\r\n\t\t},\r\n\r\n\t\tasync loadGoods() {\r\n\t\t\tif (this.loading || !this.currentTab) return\r\n\t\t\tthis.loading = true\r\n\t\t\tif (this.page === 1) uni.showLoading({ title: '加载中...' })\r\n\r\n\t\t\tconst token = uni.getStorageSync('token')\r\n\t\t\tconst profile = uni.getStorageSync('profile')\r\n\t\t\tif (!token || !profile?.university?.id) {\r\n\t\t\t\tuni.hideLoading()\r\n\t\t\t\tuni.showToast({ title: '请先登录并选择大学', icon: 'none' })\r\n\t\t\t\tthis.loading = false\r\n\t\t\t\treturn\r\n\t\t\t}\r\n\r\n\t\t\ttry {\r\n\t\t\t\tconst res = await uni.request({\r\n\t\t\t\t\turl: 'http://192.168.0.105:8080/api/goods/category',\r\n\t\t\t\t\tdata: {\r\n\t\t\t\t\t\tcategoryId: this.currentTab,           // 直接传真实的分类 id\r\n\t\t\t\t\t\tuniversityId: profile.university.id,\r\n\t\t\t\t\t\tpage: this.page,\r\n\t\t\t\t\t\tsize: this.size\r\n\t\t\t\t\t},\r\n\t\t\t\t\theader: { Authorization: 'Bearer ' + token }\r\n\t\t\t\t})\r\n\r\n\t\t\t\tconst result = res[1] || res\r\n\t\t\t\tif (result.statusCode === 200) {\r\n\t\t\t\t\tlet list = result.data || []\r\n\r\n\t\t\t\t\tlist.forEach(item => {\r\n\t\t\t\t\t\tif (item.images && typeof item.images === 'string') {\r\n\t\t\t\t\t\t\ttry {\r\n\t\t\t\t\t\t\t\tconst imgs = JSON.parse(item.images)\r\n\t\t\t\t\t\t\t\titem.cover = imgs[0] || item.cover\r\n\t\t\t\t\t\t\t} catch (e) {}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\titem.cover = item.cover || this.defaultCover\r\n\t\t\t\t\t})\r\n\r\n\t\t\t\t\tif (this.page === 1) {\r\n\t\t\t\t\t\tthis.goodsList = list\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tthis.goodsList = this.goodsList.concat(list)\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tthis.leftList = this.goodsList.filter((_, i) => i % 2 === 0)\r\n\t\t\t\t\tthis.rightList = this.goodsList.filter((_, i) => i % 2 === 1)\r\n\t\t\t\t\tthis.hasMore = list.length === this.size\r\n\t\t\t\t\tthis.firstLoad = false\r\n\t\t\t\t}\r\n\t\t\t} catch (e) {\r\n\t\t\t\tuni.showToast({ title: '加载商品失败', icon: 'none' })\r\n\t\t\t} finally {\r\n\t\t\t\tthis.loading = false\r\n\t\t\t\tuni.hideLoading()\r\n\t\t\t}\r\n\t\t},\r\n\r\n\t\tloadMore() {\r\n\t\t\tthis.page++\r\n\t\t\tthis.loadGoods()\r\n\t\t},\r\n\r\n\t\ttoDetail(id) {\r\n\t\t\tuni.navigateTo({ url: `/pages/detail/detail?id=${id}` })\r\n\t\t}\r\n\t}\r\n}\r\n</script>\r\n\r\n<style scoped>\r\n/* 样式完全不变，你原来的样式直接保留 */\r\n.category-page { background: #f8f8f8; min-height: 100vh; padding-top: 90rpx; }\r\n.tab-bar { position: fixed; top: 0; left: 0; right: 0; height: 90rpx; background: #fff; white-space: nowrap; z-index: 999; border-bottom: 1px solid #eee; }\r\n.tab-item { display: inline-block; padding: 0 32rpx; height: 100%; line-height: 90rpx; font-size: 30rpx; }\r\n.tab-item.active { color: #ff4757; position: relative; }\r\n.tab-item.active::after { content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 60rpx; height: 6rpx; background: #ff4757; border-radius: 3rpx; }\r\n\r\n/* 其他样式保持不变 */\r\n.goods-list { display: flex; padding: 20rpx 16rpx; }\r\n.column { flex: 1; }\r\n.column:first-child { margin-right: 16rpx; }\r\n.goods-card { background: #fff; border-radius: 20rpx; overflow: hidden; margin-bottom: 24rpx; box-shadow: 0 4rpx 12rpx rgba(0,0,0,0.05); }\r\n.cover { width: 100%; height: 360rpx; }\r\n.info { padding: 16rpx; }\r\n.title { display: block; font-size: 28rpx; color: #333; line-height: 1.4; height: 80rpx; overflow: hidden; }\r\n.price { display: block; font-size: 36rpx; color: #ff4757; font-weight: bold; margin: 8rpx 0; }\r\n.tags { display: flex; gap: 12rpx; }\r\n.tag { background: #fff0f0; color: #ff4757; padding: 4rpx 12rpx; border-radius: 8rpx; font-size: 22rpx; }\r\n.empty { text-align: center; padding: 100rpx 0; color: #999; }\r\n.empty-img { width: 300rpx; height: 300rpx; opacity: 0.6; }\r\n.load-more, .no-more { text-align: center; padding: 30rpx; color: #999; font-size: 28rpx; }\r\n</style>","import MiniProgramPage from 'E:/code/wechatDOC/HbUniapp/demoxiaoyuan/pages/category/category.vue'\nwx.createPage(MiniProgramPage)"],"names":["uni"],"mappings":"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"}