{"version":3,"file":"chat-list.js","sources":["pages/chat-list/chat-list.vue","../../../HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvY2hhdC1saXN0L2NoYXQtbGlzdC52dWU"],"sourcesContent":["<template>\r\n  <view class=\"chat-list-page\">\r\n    <view class=\"navbar\">\r\n      <text class=\"title\">消息</text>\r\n    </view>\r\n\r\n    <scroll-view scroll-y class=\"list\">\r\n      <view \r\n        v-for=\"item in sessions\" \r\n        :key=\"item.friendId\" \r\n        class=\"session-item\"\r\n        @click=\"toChat(item)\">\r\n        \r\n        <image class=\"avatar\" :src=\"item.avatar || '/static/default-avatar.png'\" mode=\"cover\" />\r\n        \r\n        <view class=\"info\">\r\n          <view class=\"top\">\r\n            <text class=\"nickname\">{{ item.nickname || '用户' }}</text>\r\n            <text class=\"time\">{{ formatTime(item.lastTime) }}</text>\r\n          </view>\r\n          <view class=\"bottom\">\r\n            <text class=\"last-msg\">{{ item.lastMessage || '暂无消息' }}</text>\r\n            <!-- 未读红点 -->\r\n            <view v-if=\"item.unread > 0\" class=\"unread-badge\">\r\n              {{ item.unread > 99 ? '99+' : item.unread }}\r\n            </view>\r\n          </view>\r\n        </view>\r\n      </view>\r\n\r\n      <view v-if=\"sessions.length === 0\" class=\"empty\">\r\n        <image src=\"/static/empty-msg.png\" class=\"empty-img\" />\r\n        <text>暂无消息，去逛逛商品吧~</text>\r\n      </view>\r\n    </scroll-view>\r\n  </view>\r\n</template>\r\n \r\n<script>\r\nexport default {\r\n  data() {\r\n    return {\r\n      sessions: []  // [{friendId, nickname, avatar, lastMessage, lastTime, unread}, ...]\r\n    }\r\n  },\r\n\r\n  onShow() {\r\n    this.loadSessions()\r\n    // 监听全局消息事件\r\n    uni.$on('newChatMessage', this.handleNewMessage)\r\n  },\r\n\r\n  onHide() {\r\n    // 只移除监听，不关闭 socket（全局的）\r\n    uni.$off('newChatMessage', this.handleNewMessage)\r\n  },\r\n\r\n  onUnload() {\r\n    // 同上\r\n    uni.$off('newChatMessage', this.handleNewMessage)\r\n  },\r\n\r\n  methods: {\r\n    // 加载会话列表（调用你后端新接口）\r\n    async loadSessions() {\r\n      try {\r\n        const token = uni.getStorageSync('token')\r\n        const res = await new Promise((resolve, reject) => {\r\n          uni.request({\r\n            url: 'http://192.168.0.105:8080/api/chat/sessions',  // 统一 IP\r\n            header: { Authorization: 'Bearer ' + token },\r\n            success: (res) => resolve(res.data),\r\n            fail: reject\r\n          })\r\n        }) \r\n\r\n        if (res.code === 200) {\r\n          this.sessions = res.data || []\r\n        }\r\n      } catch (e) {\r\n        console.log('加载会话失败', e)\r\n      }\r\n    },\r\n\r\n    // chat-list.vue 中跳转处改成：\r\n    toChat(item) {\r\n      uni.navigateTo({\r\n        url: '/pages/chat/chat',\r\n        success: (res) => {\r\n          // 通过 success 回调传对象参数，不会走 URL 编码\r\n          res.eventChannel.emit('acceptData', {\r\n            friendId: Number(item.friendId),\r\n            nickname: item.nickname || '用户',\r\n            avatar: item.avatar || ''\r\n          })\r\n        }\r\n      })\r\n    },\r\n\r\n    // 时间格式化\r\n    formatTime(time) {\r\n      if (!time) return ''\r\n      const d = new Date(time)\r\n      const now = Date.now()\r\n      const diff = (now - d.getTime()) / 1000\r\n\r\n      if (diff < 60) return '刚刚'\r\n      if (diff < 3600) return Math.floor(diff / 60) + '分钟前'\r\n      if (diff < 86400) return Math.floor(diff / 3600) + '小时前'\r\n      return `${d.getMonth() + 1}-${d.getDate()}`\r\n    },\r\n\r\n    // 有新消息来，更新对应会话\r\n    handleNewMessage(msg) {\r\n      const friendId = msg.fromUserId\r\n      const existing = this.sessions.find(s => s.friendId === friendId)\r\n\r\n      const newSession = {\r\n        friendId: friendId,\r\n        nickname: msg.fromNickname || '用户',  // 后端要返回昵称，或你自己存\r\n        avatar: msg.fromAvatar || '/static/default-avatar.png',\r\n        lastMessage: msg.type === 1 ? '[图片]' : msg.content || '',\r\n        lastTime: msg.createTime,\r\n        unread: existing ? existing.unread + 1 : 1\r\n      }\r\n \r\n      if (existing) {\r\n        Object.assign(existing, newSession)\r\n        // 移到顶部\r\n        this.sessions.sort((a, b) => b.lastTime.localeCompare(a.lastTime))\r\n      } else {\r\n        this.sessions.unshift(newSession)\r\n      }\r\n    }\r\n  }\r\n} \r\n</script>\r\n\r\n<style scoped>\r\n.chat-list-page { height: 100vh; background: #f5f5f5; display: flex; flex-direction: column; }\r\n.navbar { height: 90rpx; background: #fff; justify-content: center; align-items: center; font-size: 36rpx; font-weight: bold; border-bottom: 1px solid #eee; padding-top: var(--status-bar-height); }\r\n.list { flex: 1; }\r\n.session-item { display: flex; padding: 30rpx; background: #fff; border-bottom: 1px solid #f0f0f0; align-items: center; }\r\n.avatar { width: 100rpx; height: 100rpx; border-radius: 50%; margin-right: 30rpx; }\r\n.info { flex: 1; }\r\n.top { display: flex; justify-content: space-between; margin-bottom: 10rpx; }\r\n.nickname { font-size: 34rpx; font-weight: bold; }\r\n.time { color: #999; font-size: 24rpx; }\r\n.bottom { display: flex; justify-content: space-between; align-items: center; }\r\n.last-msg { color: #999; font-size: 28rpx; }\r\n.unread-badge { background: #f44; color: #fff; min-width: 40rpx; height: 40rpx; border-radius: 20rpx; text-align: center; line-height: 40rpx; font-size: 24rpx; padding: 0 12rpx; }\r\n.empty { text-align: center; padding-top: 200rpx; color: #999; }\r\n.empty-img { width: 300rpx; height: 300rpx; opacity: 0.6; }\r\n</style>","import MiniProgramPage from 'E:/code/wechatDOC/HbUniapp/demoxiaoyuan/pages/chat-list/chat-list.vue'\nwx.createPage(MiniProgramPage)"],"names":["uni","res"],"mappings":";;;AAuCA,MAAK,YAAU;AAAA,EACb,OAAO;AACL,WAAO;AAAA,MACL,UAAU,CAAI;AAAA;AAAA,IAChB;AAAA,EACD;AAAA,EAED,SAAS;AACP,SAAK,aAAa;AAElBA,kBAAAA,MAAI,IAAI,kBAAkB,KAAK,gBAAgB;AAAA,EAChD;AAAA,EAED,SAAS;AAEPA,kBAAAA,MAAI,KAAK,kBAAkB,KAAK,gBAAgB;AAAA,EACjD;AAAA,EAED,WAAW;AAETA,kBAAAA,MAAI,KAAK,kBAAkB,KAAK,gBAAgB;AAAA,EACjD;AAAA,EAED,SAAS;AAAA;AAAA,IAEP,MAAM,eAAe;AACnB,UAAI;AACF,cAAM,QAAQA,cAAAA,MAAI,eAAe,OAAO;AACxC,cAAM,MAAM,MAAM,IAAI,QAAQ,CAAC,SAAS,WAAW;AACjDA,wBAAAA,MAAI,QAAQ;AAAA,YACV,KAAK;AAAA;AAAA,YACL,QAAQ,EAAE,eAAe,YAAY,MAAO;AAAA,YAC5C,SAAS,CAACC,SAAQ,QAAQA,KAAI,IAAI;AAAA,YAClC,MAAM;AAAA,WACP;AAAA,SACF;AAED,YAAI,IAAI,SAAS,KAAK;AACpB,eAAK,WAAW,IAAI,QAAQ,CAAC;AAAA,QAC/B;AAAA,MACF,SAAS,GAAG;AACVD,sBAAAA,0DAAY,UAAU,CAAC;AAAA,MACzB;AAAA,IACD;AAAA;AAAA,IAGD,OAAO,MAAM;AACXA,oBAAAA,MAAI,WAAW;AAAA,QACb,KAAK;AAAA,QACL,SAAS,CAAC,QAAQ;AAEhB,cAAI,aAAa,KAAK,cAAc;AAAA,YAClC,UAAU,OAAO,KAAK,QAAQ;AAAA,YAC9B,UAAU,KAAK,YAAY;AAAA,YAC3B,QAAQ,KAAK,UAAU;AAAA,WACxB;AAAA,QACH;AAAA,OACD;AAAA,IACF;AAAA;AAAA,IAGD,WAAW,MAAM;AACf,UAAI,CAAC;AAAM,eAAO;AAClB,YAAM,IAAI,IAAI,KAAK,IAAI;AACvB,YAAM,MAAM,KAAK,IAAI;AACrB,YAAM,QAAQ,MAAM,EAAE,QAAS,KAAI;AAEnC,UAAI,OAAO;AAAI,eAAO;AACtB,UAAI,OAAO;AAAM,eAAO,KAAK,MAAM,OAAO,EAAE,IAAI;AAChD,UAAI,OAAO;AAAO,eAAO,KAAK,MAAM,OAAO,IAAI,IAAI;AACnD,aAAO,GAAG,EAAE,SAAS,IAAI,CAAC,IAAI,EAAE,QAAO,CAAE;AAAA,IAC1C;AAAA;AAAA,IAGD,iBAAiB,KAAK;AACpB,YAAM,WAAW,IAAI;AACrB,YAAM,WAAW,KAAK,SAAS,KAAK,OAAK,EAAE,aAAa,QAAQ;AAEhE,YAAM,aAAa;AAAA,QACjB;AAAA,QACA,UAAU,IAAI,gBAAgB;AAAA;AAAA,QAC9B,QAAQ,IAAI,cAAc;AAAA,QAC1B,aAAa,IAAI,SAAS,IAAI,SAAS,IAAI,WAAW;AAAA,QACtD,UAAU,IAAI;AAAA,QACd,QAAQ,WAAW,SAAS,SAAS,IAAI;AAAA,MAC3C;AAEA,UAAI,UAAU;AACZ,eAAO,OAAO,UAAU,UAAU;AAElC,aAAK,SAAS,KAAK,CAAC,GAAG,MAAM,EAAE,SAAS,cAAc,EAAE,QAAQ,CAAC;AAAA,aAC5D;AACL,aAAK,SAAS,QAAQ,UAAU;AAAA,MAClC;AAAA,IACF;AAAA,EACF;AACF;;;;;;;;;;;;;;;;;;;;;;;ACtIA,GAAG,WAAW,eAAe;"}