{"version":3,"file":"edit.js","sources":["pages/profile/edit.vue","../../../HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvcHJvZmlsZS9lZGl0LnZ1ZQ"],"sourcesContent":["<!-- pages/profile/edit.vue -->\r\n<template>\r\n  <view class=\"page\">\r\n    <!-- 顶部渐变背景 -->\r\n    <view class=\"hero\">\r\n      <view class=\"hero-inner\">\r\n        <view class=\"logo\"></view>\r\n        <view class=\"hero-title\">编辑资料</view>\r\n        <view class=\"hero-sub\">完善信息，更容易被信任</view>\r\n      </view>\r\n    </view>\r\n\r\n    <view class=\"content\">\r\n      <view class=\"card\">\r\n        <!-- 头像（与 publish.vue 完全一致的上传逻辑） -->\r\n        <view class=\"input-item\" @click=\"chooseAvatar\">\r\n          <text class=\"label\">头像</text>\r\n          <view class=\"upload-grid avatar-upload\">\r\n            <view class=\"img-item\" v-if=\"form.avatar\">\r\n              <image :src=\"form.avatar\" mode=\"aspectFill\" />\r\n              <view class=\"delete\" @click.stop=\"form.avatar = ''\">×</view>\r\n            </view>\r\n            <view class=\"upload-btn\" v-else>\r\n              <uni-icons type=\"plus\" size=\"36\" color=\"#ddd\" />\r\n            </view>\r\n          </view>\r\n          <uni-icons type=\"arrowright\" size=\"16\" color=\"#ccc\" />\r\n        </view>\r\n\r\n        <!-- 昵称 -->\r\n        <view class=\"input-item\" @click=\"openNicknamePopup\">\r\n          <text class=\"label\">昵称 <text class=\"req\">*</text></text>\r\n          <text class=\"value\">{{ form.nickname || '未设置' }}</text>\r\n          <uni-icons type=\"arrowright\" size=\"16\" color=\"#ccc\" />\r\n        </view>\r\n\r\n        <!-- 学校（不可修改） -->\r\n        <view class=\"input-item\" @click=\"showSchoolTip\">\r\n          <text class=\"label\">学校</text>\r\n          <text class=\"value\">{{ university?.name || '未选择' }}</text>\r\n          <uni-icons type=\"arrowright\" size=\"16\" color=\"#ccc\" />\r\n        </view>\r\n      </view>\r\n\r\n      <!-- 保存按钮 -->\r\n      <button class=\"publish-btn\" :loading=\"saving\" @click=\"saveProfile\">\r\n        {{ saving ? '保存中...' : '保存资料' }}\r\n      </button>\r\n    </view>\r\n\r\n    <!-- 昵称修改弹窗（与 publish.vue 完全一致的底部弹窗风格） -->\r\n    <uni-popup ref=\"popup\" type=\"bottom\">\r\n      <view class=\"popup-content\">\r\n        <view class=\"popup-header\">\r\n          <text @click=\"closePopup\">取消</text>\r\n          <text class=\"title\">修改昵称</text>\r\n          <text @click=\"confirmNickname\" class=\"confirm\">完成</text>\r\n        </view>\r\n        <view class=\"nickname-section\">\r\n          <input \r\n            v-model.trim=\"tempNickname\" \r\n            placeholder=\"请输入新昵称（2-12个字）\" \r\n            maxlength=\"12\" \r\n            class=\"nickname-input\"\r\n            focus\r\n          />\r\n        </view>\r\n      </view>\r\n    </uni-popup>\r\n  </view>\r\n</template>\r\n\r\n<script>\r\nexport default {\r\n  data() {\r\n    return {\r\n      form: {\r\n        avatar: '',\r\n        nickname: ''\r\n      },\r\n      university: null,\r\n      tempNickname: '',\r\n      saving: false\r\n    }\r\n  },\r\n\r\n  onLoad() {\r\n    this.loadProfile()\r\n  },\r\n\r\n  methods: {\r\n    // 加载用户信息\r\n\tloadProfile() {\r\n\t  const token = uni.getStorageSync('token')\r\n\t  if (!token) {\r\n\t\tuni.reLaunch({ url: '/pages/login/login' })\r\n\t\treturn\r\n\t  }\r\n\r\n\t  // 优先读本地缓存的 profile（更快、更丝滑）\r\n\t  const cachedProfile = uni.getStorageSync('profile')\r\n\t  if (cachedProfile) {\r\n\t\tthis.form.nickname = cachedProfile.user?.nickname || ''\r\n\t\tthis.form.avatar = cachedProfile.user?.avatar || ''\r\n\t\tthis.university = cachedProfile.university || null\r\n\t  }\r\n\r\n\t  // 再请求最新数据（确保一致性）\r\n\t  uni.request({\r\n\t\turl: 'http://192.168.0.105:8080/api/user/profile',\r\n\t\theader: { Authorization: 'Bearer ' + token },\r\n\t\tsuccess: (res) => {\r\n\t\t  if (res.statusCode === 200 && res.data) {\r\n\t\t\tconst profile = res.data\r\n\t\t\tthis.form.nickname = profile.user?.nickname || ''\r\n\t\t\tthis.form.avatar = profile.user?.avatar || ''\r\n\t\t\tthis.university = profile.university || null\r\n\r\n\t\t\t// 更新本地缓存\r\n\t\t\tuni.setStorageSync('profile', profile)\r\n\t\t  }\r\n\t\t}\r\n\t  })\r\n\t},\r\n\r\n    // 头像上传（完全复用 publish.vue 的上传逻辑）\r\n    chooseAvatar() {\r\n      uni.chooseImage({\r\n        count: 1,\r\n        success: (res) => {\r\n          const path = res.tempFilePaths[0]\r\n          uni.uploadFile({\r\n            url: 'http://192.168.0.105:8080/api/goods/upload', // 复用商品上传接口\r\n            filePath: path,\r\n            name: 'file',\r\n            header: { Authorization: 'Bearer ' + uni.getStorageSync('token') },\r\n            success: (uploadRes) => {\r\n              const data = JSON.parse(uploadRes.data)\r\n              if (data.url) {\r\n                this.form.avatar = data.url\r\n                uni.showToast({ title: '上传成功', icon: 'success' })\r\n              }\r\n            },\r\n            fail: () => {\r\n              uni.showToast({ title: '上传失败', icon: 'none' })\r\n            }\r\n          })\r\n        }\r\n      })\r\n    },\r\n\r\n    // 点击学校提示\r\n    showSchoolTip() {\r\n      uni.showModal({\r\n        title: '提示',\r\n        content: '若想修改学校信息，请去主页修改',\r\n        showCancel: false,\r\n        confirmText: '我知道了'\r\n      })\r\n    },\r\n\r\n    // 昵称弹窗\r\n    openNicknamePopup() {\r\n      this.tempNickname = this.form.nickname\r\n      this.$refs.popup.open()\r\n    },\r\n    closePopup() {\r\n      this.$refs.popup.close()\r\n    },\r\n\tconfirmNickname() {\r\n\t  const name = this.tempNickname.trim()\r\n\t  if (!name || name.length < 2 || name.length > 12) {\r\n\t\tuni.showToast({ title: '请填写2-12位的昵称', icon: 'none' })\r\n\t\treturn\r\n\t  }\r\n\r\n\t  this.form.nickname = name\r\n\t  this.form = { ...this.form }  // 这一行，天下我有！\r\n\r\n\t  this.closePopup()\r\n\t},\r\n\r\n\t// 保存资料（关键：接收并保存新 token + profile）\r\n\tsaveProfile() {\r\n\t  if (!this.form.nickname.trim()) {\r\n\t\treturn uni.showToast({ title: '请填写昵称', icon: 'none' })\r\n\t  }\r\n\r\n\t  this.saving = true\r\n\t  uni.showLoading({ title: '保存中...' })\r\n\r\n\t  uni.request({\r\n\t\turl: 'http://192.168.0.105:8080/api/user/update',\r\n\t\tmethod: 'POST',\r\n\t\theader: { Authorization: 'Bearer ' + uni.getStorageSync('token') },\r\n\t\tdata: {\r\n\t\t  nickname: this.form.nickname,\r\n\t\t  avatar: this.form.avatar || ''  // 防止传 null\r\n\t\t},\r\n\t\tsuccess: (res) => {\r\n\t\t  // 兼容你后端返回的两种格式（res.data.data 或直接 res.data）\r\n\t\t  const result = res.data?.data || res.data\r\n\r\n\t\t  if (result?.ok) {\r\n\t\t\t// 关键1：保存新 token（必须！）\r\n\t\t\tif (result.token) {\r\n\t\t\t  uni.setStorageSync('token', result.token)\r\n\t\t\t}\r\n\r\n\t\t\t// 关键2：保存完整 profile（很多页面直接读这个）\r\n\t\t\tif (result.profile) {\r\n\t\t\t  uni.setStorageSync('profile', result.profile)\r\n\t\t\t}\r\n\r\n\t\t\tuni.hideLoading()\r\n\t\t\tuni.showToast({ title: '保存成功', icon: 'success' })\r\n\r\n\t\t\t// 可选：延迟返回，让用户看到成功提示\r\n\t\t\tsetTimeout(() => {\r\n\t\t\t  uni.navigateBack()\r\n\t\t\t}, 1200)\r\n\t\t  } else {\r\n\t\t\tuni.hideLoading()\r\n\t\t\tuni.showToast({\r\n\t\t\t  title: result?.message || '保存失败，请重试',\r\n\t\t\t  icon: 'none'\r\n\t\t\t})\r\n\t\t  }\r\n\t\t},\r\n\t\tfail: (err) => {\r\n\t\t  uni.hideLoading()\r\n\t\t  console.error('保存资料失败', err)\r\n\t\t  uni.showToast({ title: '网络错误', icon: 'none' })\r\n\t\t},\r\n\t\tcomplete: () => {\r\n\t\t  this.saving = false\r\n\t\t}\r\n\t  })\r\n\t}\r\n  }\r\n}\r\n</script>\r\n\r\n<style scoped>\r\n/* 完全复用 publish.vue 的视觉风格 */\r\n.page { background: #f8f8f8; min-height: 100vh; padding-bottom: 100rpx; }\r\n.hero { height: 200px; background: linear-gradient(135deg, #667eea, #764ba2); border-bottom-left-radius: 24px; border-bottom-right-radius: 24px; }\r\n.hero-inner { height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; }\r\n.logo { width: 64px; height: 64px; border-radius: 32px; background: #fff; opacity: 0.9; margin-bottom: 12px; }\r\n.hero-title { color: #fff; font-size: 22px; font-weight: 600; }\r\n.hero-sub { color: #eef; font-size: 14px; margin-top: 4px; }\r\n.content { padding: 32rpx; margin-top: -40px; }\r\n.card { background: #fff; border-radius: 20rpx; overflow: hidden; box-shadow: 0 6rpx 16rpx rgba(0,0,0,0.06); }\r\n.input-item { padding: 32rpx; display: flex; align-items: center; justify-content: space-between; border-bottom: 1rpx solid #f0f0f0; }\r\n.input-item:last-child { border-bottom: none; }\r\n.label { font-size: 32rpx; }\r\n.req { color: #ff4757; }\r\n.value { flex: 1; text-align: right; color: #333; font-size: 32rpx; margin-right: 20rpx; }\r\n\r\n/* 头像上传区域（与 publish.vue 完全一致） */\r\n.avatar-upload { width: 140rpx; height: 140rpx; }\r\n.upload-grid { display: flex; }\r\n.img-item, .upload-btn { width: 140rpx; height: 140rpx; border-radius: 20rpx; overflow: hidden; position: relative; background: #f9f9f9; border: 2rpx dashed #ddd; }\r\n.img-item image { width: 100%; height: 100%; }\r\n.delete { position: absolute; top: 0; right: 0; background: rgba(0,0,0,0.6); color: #fff; width: 40rpx; height: 40rpx; text-align: center; line-height: 40rpx; border-radius: 0 0 0 20rpx; font-size: 40rpx; }\r\n.upload-btn { display: flex; align-items: center; justify-content: center; }\r\n\r\n/* 保存按钮（与发布按钮同款） */\r\n.publish-btn { margin: 60rpx 32rpx; background: linear-gradient(135deg, #ff6b6b, #ee5a52); color: #fff; height: 88rpx; line-height: 88rpx; border-radius: 88rpx; font-size: 36rpx; font-weight: bold; }\r\n\r\n/* 昵称弹窗（完全复用 publish.vue 的分类弹窗风格） */\r\n.popup-content { background: #fff; border-radius: 24rpx 24rpx 0 0; }\r\n.popup-header { padding: 32rpx; display: flex; justify-content: space-between; align-items: center; font-size: 32rpx; border-bottom: 1rpx solid #eee; }\r\n.popup-header .title { font-weight: bold; }\r\n.popup-header .confirm { color: #007AFF; }\r\n.nickname-section { padding: 40rpx 32rpx; }\r\n.nickname-input { width: 100%; height: 100rpx; border: 2rpx solid #eee; border-radius: 20rpx; padding: 0 32rpx; font-size: 32rpx; text-align: center; }\r\n</style>","import MiniProgramPage from 'E:/code/wechatDOC/HbUniapp/demoxiaoyuan/pages/profile/edit.vue'\nwx.createPage(MiniProgramPage)"],"names":["uni","_a","_b"],"mappings":"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"}